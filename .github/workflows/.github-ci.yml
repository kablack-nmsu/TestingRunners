name: Shell-Based Python Build and Test

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-job:
    runs-on: self-hosted
    steps:
      - name: Manual Git Checkout
        run: |
          echo "Cloning repository..."
          git clone --depth 1 "https://github.com/${{ github.repository }}" . 
          git checkout ${{ github.sha }}
          echo "Checkout complete."

      - name: Execute Build Commands
        run: |
          hostname
          python3 --version
          echo "Compile complete."

  run-job:
    needs: build-job
    runs-on: ubuntu-latest

    steps:
      - name: Manual Git Checkout
        run: |
          echo "Cloning repository for run job..."
          git clone --depth 1 "https://github.com/${{ github.repository }}" . 
          git checkout ${{ github.sha }}

      - name: Install Python and Dependencies
        run: |
          echo "Installing Python 3 and venv module..."
          sudo apt-get update
          sudo apt-get install -y python3-venv
          echo "Installation complete."

      - name: Deploy Virtual Environment and Run Script
        run: |
          echo "Current working directory: $(pwd)"
          
          python3 -m venv venvRG
          
          source venvRG/bin/activate
          
          echo "--- VENV Activated. Running script ---"
          
          ./venvRG/bin/python app/randomgrid.py
          
          deactivate
          rm -rf venvRG
          
          echo "Virtual environment cleanup complete."
